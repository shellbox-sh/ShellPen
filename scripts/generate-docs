#! /usr/bin/env bash

generateREADME() {
  cp docs/_templates/readmeHeader.md README.md
  cat docs/_templates/index.md >> README.md
}

generateWebsiteIndex() {
  cp docs/_templates/websiteHeader.md docs/index.md
  cat docs/_templates/index.md >> docs/index.md
  echo >> docs/index.md
  echo '{% endraw %}' >> docs/index.md
}

generateREADME
generateWebsiteIndex

[ "$1" = "-x" ] && exit 0

#

TEMPLATE=docs/_templates/command_reference.shx.md
API_ROOT=api

source vendor/docgen.sh
source vendor/shx.sh

if [ "$1" = "--tree" ]
then
  shift
  tree="$1"
  shift
else
  tree="$( mktemp -d )"
fi

docgen parseTree setRoot "$tree"

if [ "$1" = "--parse" ]
then
  shift
  [ -d "$tree" ] && rm -r "$tree"
  mkdir -p "$tree"
  docgen parseToTree src/
else
  [ -d "$tree" ] || { echo "Tree not found '$tree' - try calling with --tree [tree] --parse to create new" >&2; exit 1; }
fi

if [ "$1" = "--recurse" ]
then
  recurse=true
  shift
fi

[ $# -eq 0 ] && { echo "Please provide @command paths to generate Markdown files for" >&2; exit 1; }

tree -a "$tree"

docgen context create new

context() { docgen context "$@"; }
command() { docgen context commands "$@"; }

writeMarkdownFile() {
  local markdownFile="docs/${1/#"@commands"/"$API_ROOT"}.md"

  mkdir -p "${markdownFile%/*}"

  [ "${markdownFile##*/}" = ':.md' ] && markdownFile="${markdownFile/%:.md/colon.md}"

  shx render "$TEMPLATE" > "$markdownFile"
}

writeMarkdownFiles() {
  local commandPath="$1"

  echo "writeMarkdownFiles $commandPath"

  docgen context goto path "$commandPath"

  echo "$( writeMarkdownFile "$commandPath" )"

  if [ "$recurse" = true ]
  then
    declare -a commandPaths=()
    if docgen context commands list commandPaths
    then
      commandPath=''
      for commandPath in "${commandPaths[@]}"
      do
        echo "$( writeMarkdownFiles "$commandPath" )"
      done
    fi
  fi
}

for arg in "$@"
do
  writeMarkdownFiles "@commands/$arg"
done